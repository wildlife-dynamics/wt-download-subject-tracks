id: download_subjects
requirements:
  - name: ecoscope-workflows-core
    version: ">=0.20.6,<0.21"
    channel: https://repo.prefix.dev/ecoscope-workflows/
  - name: ecoscope-workflows-ext-ecoscope
    version: ">=0.20.6,<0.21"
    channel: https://repo.prefix.dev/ecoscope-workflows/
  - name: ecoscope-workflows-ext-custom
    version: ">=0.0.19, <0.1.0"
    channel: https://repo.prefix.dev/ecoscope-workflows-custom/
rjsf-overrides:
  properties:
    Subject Group.properties.subject_obs.properties.include_details.default: true
    Generate Maps.properties.skip_map_generation.properties.skip.description: >-
      Skip generating maps for subject tracks. Recommended for large datasets to improve performance.
    Generate Maps.properties.base_map_defs.properties.base_maps.title: "Map Base Layers"
    persist_tracks.properties.filename_prefix.default: "subject_tracks"
    Process Observations.properties.customize_columns.properties.drop_columns.default: ["location", "patrol_serial_number", "patrol_status", "patrol_subject", "patrol_type__value", "subject__content_type", "subject__device_status_properties", "subject__user"]
  
  $defs:
    ValueGrouper: {
      description: "Use a categorical column to group data by. If you're unsure which columns are available, run the workflow once without grouping to see the data, then configure grouping in a subsequent run.",
      title: "Category",
      "type": "string"
    }

  uiSchema:
    Process Observations.filter_obs.filter_point_coords.items.ui:options.label: false
    Process Observations.customize_columns.rename_columns.items.ui:options.label: false
    base_map_defs.base_maps.items.ui:options.label: false
task-instance-defaults:
  skipif:
    conditions:
      - any_is_empty_df
      - any_dependency_skipped

workflow:
  - name: Workflow Details
    id: workflow_details
    task: set_workflow_details

  - name: Time Range
    id: time_range
    task: set_time_range
    partial:
      time_format: "%d %b %Y %H:%M:%S"

  - name: Extract Timezone Selection
    id: get_timezone
    task: get_timezone_from_time_range
    partial:
      time_range: ${{ workflow.time_range.return }}

  - name: Data Source
    id: er_client_name
    task: set_er_connection

  # subject group observations
  - title: Subject Group
    type: task-group
    description: >-
      Choose a subject group to analyze
    tasks:
      - name: "" # Get Subject Group Observations from EarthRanger
        id: subject_obs
        task: get_subjectgroup_observations
        partial:
          client: ${{ workflow.er_client_name.return }}
          time_range: ${{ workflow.time_range.return }}
          raise_on_empty: false

  - name: Warn if mixed subtype
    id: warn_if_mixed_subtype
    task: mixed_subtype_warning
    skipif:
      conditions:
        - never
    partial:
      subject_obs: ${{ workflow.subject_obs.return }}

  - title: Process Observations
    type: task-group
    description: >-
      Process observations by applying filters, SQL queries, etc. Note that the data here includes all the columns from the previous steps and the normalized subject/observation details.
    tasks:
      - name: "Convert to timezone"
        id: convert_to_user_timezone
        task: convert_values_to_timezone
        partial:
          df: ${{ workflow.subject_obs.return }}
          timezone: ${{ workflow.get_timezone.return }}
          columns: ["fixtime"]

      - name: Remove Column Prefix Extra
        id: drop_extra_prefix
        task: drop_column_prefix
        partial:
          df: ${{ workflow.convert_to_user_timezone.return }}
          prefix: "extra__"
          duplicate_strategy: "suffix"

      - name: Filter Observation Relocations
        id: filter_obs
        task: apply_reloc_coord_filter
        partial:
          df: ${{ workflow.drop_extra_prefix.return }}
          roi_gdf: null
          roi_name: null
          reset_index: false

      - name: Trajectory Segment Filter
        id: subject_traj
        task: relocations_to_trajectory
        partial:
          relocations: ${{ workflow.filter_obs.return }}

      - name: Remove Column Prefix Extra
        id: drop_extra_prefix_traj
        task: drop_column_prefix
        partial:
          df: ${{ workflow.subject_traj.return }}
          prefix: "extra__"
          duplicate_strategy: "suffix"

      - name: Internally Process Columns
        id: customize_columns_internally
        task: map_columns
        partial:
          df: ${{ workflow.drop_extra_prefix_traj.return }}
          rename_columns: {}
          drop_columns: ["id"] # drop 'id' to avoid conflict with `id` in the index
          retain_columns: []

      - name: Process Columns
        id: customize_columns
        task: map_columns
        partial:
          df: ${{ workflow.customize_columns_internally.return }}

      - name: Apply SQL Query
        id: sql_query
        task: apply_sql_query
        partial:
          df: ${{ workflow.customize_columns.return }}

      - name: Group Data
        id: groupers
        task: set_groupers

      - name: Add temporal index to observations
        id: obs_add_temporal_index
        task: add_temporal_index
        partial:
          df: ${{ workflow.sql_query.return }}
          time_col: "segment_start"
          groupers: ${{ workflow.groupers.return }}
          cast_to_datetime: true
          format: "mixed"

      - name: Split Trajectory by Group
        id: split_traj_groups
        task: split_groups
        partial:
          df: ${{ workflow.obs_add_temporal_index.return }}
          groupers: ${{ workflow.groupers.return }}

  - name: Persist Subject Trajectories
    id: persist_tracks
    task: persist_df_wrapper
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      sanitize: true
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.split_traj_groups.return }}
    skipif:
      conditions:
        - never

  - title: Generate Maps
    type: task-group
    description: >-
      Generate maps to visualize the subject trajectories.
    tasks:
      - name: Skip Map Generation
        id: skip_map_generation
        task: maybe_skip_df
        mapvalues:
          argnames: df
          argvalues: ${{ workflow.split_traj_groups.return }}

      # Widget Names
      - name: "Set Trajectory Map Title"
        id: set_traj_map_title
        task: set_string_var
        partial:
          var: "Subject Group Trajectory Map"

      - name: " "
        id: base_map_defs
        task: set_base_maps

      - name: Apply Color to Trajectories By Subject
        id: colormap_traj
        task: assign_subject_colors
        partial:
          subject_id_column: "subject__id"
          output_column: "subject_colormap"
          fallback_strategy: default_color
          default_color: "#FFFF00"
          default_palette: "tab20b"
          additional_column: "subject__additional"
        mapvalues:
          argnames: df
          argvalues: ${{ workflow.skip_map_generation.return }}

      - name: Sort Subject Names
        id: sort_subject_names
        task: sort_values
        partial:
          column_name: "subject__name"
          ascending: true
          na_position: "last"
        mapvalues:
          argnames: df
          argvalues: ${{ workflow.colormap_traj.return }}

      - name: Rename columns for map tooltip display
        id: rename_display_columns
        task: map_columns
        partial:
          drop_columns: []
          retain_columns: []
          rename_columns:
            segment_start: "Start"
            timespan_seconds: "Duration (s)"
            speed_kmhr: "Speed (kph)"
            subject__name: "Subject Name"
            subject__sex: "Subject Sex"
        mapvalues:
          argnames: df
          argvalues: ${{ workflow.sort_subject_names.return }}
      - name: Create map layer for each trajectory group
        id: traj_map_layers
        task: create_polyline_layer
        skipif:
          conditions:
            - any_is_empty_df
            - any_dependency_skipped
            - all_geometry_are_none
        partial:
          layer_style:
            color_column: "subject_colormap"
          legend:
            label_column: "Subject Name"
            color_column: "subject_colormap"
          tooltip_columns: ["Start", "Duration (s)", "Speed (kph)", "Nighttime", "Subject Name", "Subject Sex"]
        mapvalues:
          argnames: geodataframe
          argvalues: ${{ workflow.rename_display_columns.return }}
      - name: Draw Ecomaps for each trajectory group
        id: traj_ecomap
        task: draw_ecomap
        partial:
          tile_layers: ${{ workflow.base_map_defs.return }}
          north_arrow_style:
            placement: "top-left"
          legend_style:
            title: "Subject"
            format_title: false
            placement: "bottom-right"
          static: false
          title: null
          max_zoom: 20
          widget_id: ${{ workflow.set_traj_map_title.return }}
        mapvalues:
          argnames: geo_layers
          argvalues: ${{ workflow.traj_map_layers.return }}
      - name: Persist ecomap as Text
        id: ecomap_html_urls
        task: persist_text
        partial:
          root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
          filename_suffix: "v2"
        mapvalues:
          argnames: text
          argvalues: ${{ workflow.traj_ecomap.return }}
      - name: Create Map Widgets for Trajectories
        id: traj_map_widgets_single_views
        task: create_map_widget_single_view
        skipif:
          conditions:
            - never
        partial:
          title: ${{ workflow.set_traj_map_title.return }}
        map:
          argnames: [view, data]
          argvalues: ${{ workflow.ecomap_html_urls.return }}
      - name: Merge EcoMap Widget Views
        id: traj_grouped_map_widget
        task: merge_widget_views
        partial:
          widgets: ${{ workflow.traj_map_widgets_single_views.return }}

  # dashboard
  - name: Create Dashboard with Subject Tracking Widgets
    id: subject_tracking_dashboard
    task: gather_dashboard
    partial:
      details: ${{ workflow.workflow_details.return}}
      widgets:
        - ${{ workflow.traj_grouped_map_widget.return }}
      groupers: ${{ workflow.groupers.return }}
      time_range: ${{ workflow.time_range.return}}
      warning: ${{ workflow.warn_if_mixed_subtype.return}}
